# Укрощаем ИИ-контекст: связка OpenSpec и Beads в Cursor

Разработка с ИИ-ассистентами часто напоминает поездку с талантливым, но забывчивым штурманом. Он отлично знает карту (код), но постоянно забывает пункт назначения (бизнес-задачу) и пройденный маршрут (контекст).

Мы привыкли работать в режиме "Prompt & Pray": написали длинный промпт, получили код, внесли правки. Но на дистанции сложной фичи контекст размывается. Агент начинает галлюцинировать, терять детали или переписывать одно и то же. Проблема не в модели, а в отсутствии **долгосрочной памяти** и **четкого контракта**.

В этой статье я расскажу, как превратить хаотичный диалог с Cursor в структурированный инженерный процесс. Мы объединим два инструмента:

1.  **OpenSpec** - чтобы зафиксировать "что и зачем мы делаем" (Spec-Driven Development).
2.  **Beads** - чтобы управлять тем, "как и в каком порядке" это выполнять (граф задач).
3.  **Cursor** - как среду, которая связывает их воедино.

Если вы устали от того, что ИИ теряет нить повествования на середине рефакторинга, этот подход для вас.

## Проблема контекста

Когда мы даем задачу живому разработчику, мы не диктуем ему каждую строчку. Мы даем ТЗ (спецификацию) и ожидаем, что он сам разобьет работу на этапы. С ИИ мы часто пропускаем этот ритуал, сразу требуя код.

OpenSpec и Beads решают эту проблему, перенося менеджмент задач внутрь репозитория. Это не внешняя Jira, которую ИИ не видит. Это файлы, которые лежат рядом с кодом и являются единственным источником правды.

## OpenSpec: Контракт вместо чата

OpenSpec - это фреймворк, который заставляет вас (и агента) сначала планировать, а потом делать. Вместо того чтобы сразу бросаться в реализацию, мы создаем "Change" - папку с описанием изменений.

Внутри Change живут три главных файла:

- `proposal.md` - бизнес-контекст. Зачем это нужно?
- `tasks.md` - верхнеуровневый план.
- `spec.md` - техническая спецификация. Как это должно работать? Какие форматы данных? Какие ограничения?

Ценность OpenSpec в том, что он **отделяет намерение от реализации**. Спецификация становится контрактом. Пока контракт не утвержден (вами), код писать рано. А когда код написан, мы можем автоматически проверить, соответствует ли он контракту.

В Cursor это работает нативно через команды `/openspec-proposal`, `/openspec-apply`. Агент сам генерирует структуру, вы ее правите, и только после согласования начинается работа.

## Beads: Графовая память агента

Обычный список TODO плох тем, что он линейный. Реальная разработка - это граф. "Нельзя делать фронтенд, пока не готова ручка API". "Нельзя мержить, пока не пройдены тесты".

Beads (разработка того самого Стива Йегги) - это инструмент, который хранит задачи в виде графа зависимостей прямо в папке `.beads/`.

Почему это важно для ИИ:

1.  **Состояние**: Агент точно знает, какие задачи `ready` (можно брать), а какие `blocked` (ждут зависимости).
2.  **Изоляция**: Агент берет одну маленькую задачу, делает ее, закрывает (`bd close`) и забывает. Ему не нужно держать в контексте весь проект.
3.  **Воспроизводимость**: Вся история работы сохраняется в git. Вы можете в любой момент посмотреть, почему было принято то или иное решение.

---

## Часть 1. Настройка среды (Tutorial)

Чтобы повторить этот workflow, вам понадобится установить инструменты и подготовить проект.

### Установка (один раз на машину)

```bash
# OpenSpec
npm install -g @fission-ai/openspec@latest

# Beads
npm install -g @beads/bd@latest
```

### Инициализация в проекте

Заходим в корень вашего проекта:

```bash
# Инициализация OpenSpec
# Вас спросят про IDE - выбирайте "Cursor" для авто-настройки команд
openspec init

# Инициализация Beads
# Создаст папку .beads/ и базовый AGENTS.md
bd init
bd onboard
```

Теперь у вас есть инфраструктура. Но чтобы Cursor научился связывать эти инструменты, нам нужно добавить ему кастомные инструкции.

### Настройка правил для агента

Создайте или обновите файл `.cursor/rules/AGENTS.md`. Это "системный промпт", который Cursor читает перед каждым ответом.

<details>
<summary>Показать полный код AGENTS.md</summary>

```markdown
# AGENTS.md — инструкция для кодовых агентов

## Обзор

В этом репозитории мы используем:

- **OpenSpec** (`openspec/`) — для спецификаций и изменений.
- **Beads** (`.beads/`) — для графа задач.
- **Cursor** — как исполнителя.

## Workflow для агентов

### 1. Планирование (OpenSpec)

1. Для новой фичи используй `/openspec-proposal "<название>"`.
2. Читай и улучшай `proposal.md`, `tasks.md`, `spec.md`.
3. Цель: чёткий scope и выполнимые задачи.

### 2. Задачи (Beads)

1. После того как change согласован, используй `/openspec-to-beads <id>`.
2. Создавай:
   - один эпик Beads на фичу;
   - задачи уровня "один человек за ≤ 0.5–1 день";
   - явные зависимости (infra → backend → UI → tests/docs).
3. После генерации задач:
   - вызывай `bd ready`;
   - двигайся по списку незаблокированных задач.

### 3. Имплементация

Для каждой задачи:

1. `bd show <id>` — пойми контекст.
2. Реализуй код по спеке.
3. `bd close <id>`.

### 4. Завершение

1. `bd ready` пуст?
2. `/openspec-apply <id>` — сверь код со спекой.
3. `/openspec-archive <id>`.
```

## Стиль кода и ожидания

- Держи PR’ы и задачи небольшими и атомарными.
- Не ломай существующие контракты, если только это не отражено в OpenSpec‑спеках.
- Если OpenSpec и код расходятся — сначала обнови OpenSpec, затем код, затем Beads‑задачи.

## Чего делать не нужно

- Не внедряй крупные фичи "из головы" без OpenSpec‑change.
- Не храни планы только в чате: всегда синхронизируй их с OpenSpec и Beads.
- Не создавай Beads‑задачи без привязки к OpenSpec‑change, кроме мелких техдолгов/фиксов.

</details>

### Добавление кастомной команды

Чтобы агент умел одной командой превращать markdown-план в граф задач, создайте файл `.cursor/commands/openspec-to-beads.md`.

<details>
<summary>Показать код команды /openspec-to-beads</summary>

```markdown
# /openspec-to-beads

Use this command after an OpenSpec change is approved.

## What to do

1. Ask the user (if not provided) which OpenSpec change ID to use.
2. Read:
   - `openspec/changes/<id>/proposal.md`
   - `openspec/changes/<id>/tasks.md`
   - any `openspec/changes/<id>/specs/**/spec.md`
3. Based on these files:
   - Create a Beads epic with `bd create "Implement <feature-name>" --type epic --priority 0`.
   - For each concrete implementation step in `tasks.md`, create a child task:
     - `bd create "<task title>" --type task --parent <epic-id> --priority 0 or 1`.
   - Add dependencies using `bd dep add <child-id> <parent-id>`:
     - migrations & infra → block backend
     - backend → block UI
     - implementation → block release/docs
4. Run `bd ready` and summarize which tasks are now ready to start.
5. Print:
   - epic ID
   - all created task IDs
   - a short explanation of the dependency graph.
```

</details>

---

## Часть 2. Единый Workflow в действии

Теперь, когда всё настроено, вот как выглядит идеальный цикл разработки фичи.

### 1. Формирование намерения

Вы пишете в чат:

```text
/openspec-proposal "Добавить 2FA авторизацию"
```

Что делает OpenSpec:

- создает change-папку в `openspec/changes/<id>/` с:
  - `proposal.md` - бизнес-описание (зачем / что);
  - `tasks.md` - список задач;
  - `design.md` (если нужно) - техдизайн;
  - `specs/.../spec.md` - требования и критерии приёмки.

**Ваша задача:** через Cursor отредактировать `proposal.md`, `tasks.md` и `specs/.../spec.md` до состояния "можно подписывать как контракт".

### 2. Трансформация в задачи

Когда change согласован, запускаем нашу новую команду:

```text
/openspec-to-beads <change-id>
```

**Логика работы агента:**

Агент читает файлы changes и автоматически создает структуру задач:

1. Создает эпик в Beads.
2. Для каждой задачи из `tasks.md` создает задачу в Beads.
3. Проставляет зависимости между ними.

Например:

- "Создать таблицу users" (блокирует Бэкенд)
- "API эндпоинт" (блокируется Базой, блокирует Фронтенд)
- "Форма входа" (блокируется API)

В итоге получаем **живой граф задач в `.beads/`**, а не просто текст.

### 3. Исполнение

Дальше работаем в цикле:

```bash
bd ready             # какие задачи можно брать прямо сейчас
bd show <id>         # детали задачи (описание, deps, parent)
# делаем работу в коде
bd close <id>        # закрываем задачу
bd sync              # синхронизация с Git
```

Агент смотрит список `bd ready`. Видит только то, что можно делать сейчас. Он берет задачу, выполняет её, прогоняет тесты. Пишет `bd close <id>`. Beads автоматически разблокирует следующие задачи.

### 4. Фиксация

Когда все задачи закрыты, вы делаете:

```text
/openspec-apply <change-id>    # убедиться, что код соответствует спекам
/openspec-archive <change-id>  # заархивировать change как завершённый
```

OpenSpec сохраняет спеку как **историю изменения системы**, Beads - как **историю работы**.

---

## Ментальный чек-лист для агента

Если вы хотите быстро проверить, правильно ли работает ваш ИИ-ассистент, сверьте его действия с этим чек-листом. Эту же логику стоит держать в голове при code review.

- **Сначала** спроси: "Есть ли уже OpenSpec-change?"
  - если нет - создай `/openspec-proposal`.
  - если есть - читай его и не выдумывай требования.
- **Потом** проверь: "Отражён ли план в Beads?"
  - если нет - используй `/openspec-to-beads`.
  - если да - следуй `bd ready`.
- **Всегда** держи в согласии: `OpenSpec (что) ↔ Beads (как/когда) ↔ код (реализация)`.

## Заключение

Использование OpenSpec и Beads превращает "общение с чат-ботом" в управление виртуальным сотрудником. Вы перестаете бороться с потерей контекста. Спецификация держит рамки продукта, Beads держит порядок действий, а Cursor обеспечивает интерфейс.

Это позволяет делать сложные, многоэтапные задачи, не боясь, что к десятому сообщению агент забудет, с чего всё начиналось.

> Кодер с новой технологией - как маньяк с бензопилой, который носится по этажам психбольницы и пытается везде её применить.

## Полезные ссылки

1.  [OpenSpec + Cursor Forum Discussion](https://forum.cursor.com/t/openspec-lightweight-portable-spec-driven-framework-for-ai-coding-assistants/134052)
2.  [OpenSpec GitHub](https://github.com/Fission-AI/OpenSpec)
3.  [Beads GitHub](https://github.com/steveyegge/beads)
4.  [Beads Best Practices (Steve Yegge)](https://steve-yegge.medium.com/beads-best-practices-2db636b9760c)
5.  [AGENTS.md Specification](https://agents.md/)
